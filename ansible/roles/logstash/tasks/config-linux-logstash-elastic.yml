- name: Set Elasticsearch logstash password
  ansible.builtin.uri:
    url: https://127.0.0.1:9200/_security/user/logstash_system/_password
    ca_path: '/opt/elasticsearch/config/certs/ca/ca.crt'
    return_content: true
    user: "elastic"
    password: "{{ lookup('community.hashi_vault.vault_kv2_get', 'elastic', engine_mount_point='secrets')['secret']['elasticsearch'] }}"
    method: POST
    body_format: "json"
    body:
      password: "{{ lookup('community.hashi_vault.vault_kv2_get', 'elastic', engine_mount_point='secrets')['secret']['logstash'] }}"

- name: Set Elasticsearch Default ILM (7 day)
  ansible.builtin.uri:
    url: https://127.0.0.1:9200/_ilm/policy/sevenday-default
    ca_path: '/opt/elasticsearch/config/certs/ca/ca.crt'
    return_content: true
    user: "elastic"
    password: "{{ lookup('community.hashi_vault.vault_kv2_get', 'elastic', engine_mount_point='secrets')['secret']['elasticsearch'] }}"
    method: PUT
    body_format: "json"
    body: "{{ lookup('file', 'elastic/ilm/default-7day.json') }}"

- name: Set Elasticsearch Default ILM (30 day)
  ansible.builtin.uri:
    url: https://127.0.0.1:9200/_ilm/policy/thirtyday-default
    ca_path: '/opt/elasticsearch/config/certs/ca/ca.crt'
    return_content: true
    user: "elastic"
    password: "{{ lookup('community.hashi_vault.vault_kv2_get', 'elastic', engine_mount_point='secrets')['secret']['elasticsearch'] }}"
    method: PUT
    body_format: "json"
    body: "{{ lookup('file', 'elastic/ilm/default-30day.json') }}"

- name: Set Elasticsearch Winlogbeat template
  ansible.builtin.uri:
    url: https://127.0.0.1:9200/_index_template/winlogbeat_template
    ca_path: '/opt/elasticsearch/config/certs/ca/ca.crt'
    return_content: true
    user: "elastic"
    password: "{{ lookup('community.hashi_vault.vault_kv2_get', 'elastic', engine_mount_point='secrets')['secret']['elasticsearch'] }}"
    method: PUT
    body_format: "json"
    body: "{{ lookup('file', 'elastic/template/winlogbeat.json') }}"
  
- name: Set Elasticsearch Filebeat template
  ansible.builtin.uri:
    url: https://127.0.0.1:9200/_index_template/filebeat_template
    ca_path: '/opt/elasticsearch/config/certs/ca/ca.crt'
    return_content: true
    user: "elastic"
    password: "{{ lookup('community.hashi_vault.vault_kv2_get', 'elastic', engine_mount_point='secrets')['secret']['elasticsearch'] }}"
    method: PUT
    body_format: "json"
    body: "{{ lookup('file', 'elastic/template/filebeat.json') }}"
